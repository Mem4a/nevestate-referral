<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Nevestate Partner</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –ë–ê–ó–û–í–´–ï –ù–ê–°–¢–†–û–ô–ö–ò --- */
        :root {
            --primary-gold: #bba589;
            --bg-color: #ffffff;
            --text-color: #333333;
            --input-bg: #eeeeee;
            --error-color: #ff3b30;
        }

        body { 
            font-family: 'Helvetica Neue', Arial, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; padding: 0; box-sizing: border-box; 
            min-height: 100vh;
        }

        .hidden { display: none !important; }

        /* --- –≠–ö–†–ê–ù–´ --- */
        .app-screen {
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
            animation: fadeIn 0.3s ease-in-out;
        }

        /* --- –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò --- */
        #loaderScreen { 
            justify-content: center; 
            color: #999; 
            position: fixed; top: 0; left: 0; width: 100%; z-index: 999; background: #fff;
        }

        /* --- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ --- */
        #mainMenuScreen { justify-content: center; text-align: center; }

        .logo-area {
            width: 120px; height: 120px; background-color: #f5f5f5; border-radius: 50%;
            margin-bottom: 20px; display: flex; align-items: center; justify-content: center;
            font-size: 40px; color: var(--primary-gold); border: 2px solid var(--primary-gold);
            overflow: hidden;
        }

        .app-title { font-family: 'Georgia', serif; font-size: 24px; margin-bottom: 10px; color: #000; }
        .app-subtitle { font-size: 14px; color: #777; margin-bottom: 30px; max-width: 300px; line-height: 1.5; }

        .menu-btn {
            width: 100%; max-width: 300px; padding: 16px; margin-bottom: 12px;
            border-radius: 100px; border: none; font-size: 15px; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background-color: var(--primary-gold); color: #fff; text-transform: uppercase; font-family: 'Georgia', serif; }
        .btn-secondary { background-color: var(--input-bg); color: #333; }
        .btn-hr { background-color: #333; color: #fff; } /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ HR */

        /* --- –§–û–†–ú–´ --- */
        .my-form-container { width: 100%; max-width: 380px; text-align: left; }
        h3.form-title { font-family: 'Georgia', serif; text-align: center; margin-bottom: 25px; font-size: 22px; color: #000; }
        .form-label { margin-left: 15px; margin-bottom: 5px; font-size: 13px; color: #999; display: block; }
        
        .my-form-container input, .my-form-container select, .my-form-container textarea {
            width: 100%; padding: 15px 25px; border-radius: 30px; border: none; 
            background-color: var(--input-bg); color: #5c5c5c; font-size: 16px; 
            box-sizing: border-box; margin-bottom: 12px; outline: none; appearance: none;
        }
        .my-form-container textarea { border-radius: 20px; min-height: 100px; resize: vertical; }
        .my-form-container input:focus, .my-form-container select:focus, .my-form-container textarea:focus { box-shadow: 0 0 0 2px var(--primary-gold); background-color: #fff; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loaderScreen" class="app-screen">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 38 38" stroke="#bba589">
            <g fill="none" fill-rule="evenodd"><g transform="translate(1 1)" stroke-width="2"><circle stroke-opacity=".5" cx="18" cy="18" r="18"/><path d="M36 18c0-9.94-8.06-18-18-18"><animateTransform attributeName="transform" type="rotate" from="0 18 18" to="360 18 18" dur="1s" repeatCount="indefinite"/></path></g></g>
        </svg>
    </div>

    <div id="mainMenuScreen" class="app-screen hidden">
        <div class="logo-area"><span>N</span></div>
        <h1 class="app-title">NEVESTATE PORTAL</h1>
        <p class="app-subtitle">–ï–¥–∏–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–¥–µ–ª–∫–∞–º–∏ –∏ –∫–æ–º–∞–Ω–¥–æ–π.</p>

        <button class="menu-btn btn-primary" onclick="openScreen('referralFormScreen')">
            + –ü–µ—Ä–µ–¥–∞—Ç—å –ª–∏–¥
        </button>
        
        <button class="menu-btn btn-secondary" onclick="openScreen('hrRequestScreen')">
            üë§ –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        </button>

        <button id="hrCabinetBtn" class="menu-btn btn-hr hidden" onclick="openScreen('hrCabinetScreen')">
            ‚öôÔ∏è –ö–∞–±–∏–Ω–µ—Ç HR
        </button>
    </div>

    <div id="referralFormScreen" class="app-screen hidden">
        <div class="my-form-container">
            <h3 class="form-title">–ü–µ—Ä–µ–¥–∞—á–∞ –∫–ª–∏–µ–Ω—Ç–∞</h3>
            
            <label class="form-label">–°—Ç—Ä–∞–Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞</label>
            <select id="countrySelect" onchange="filterBrokers()"><option value="" selected>–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>

            <label class="form-label">–ü—Ä–∏–Ω–∏–º–∞—é—â–∏–π –±—Ä–æ–∫–µ—Ä</label>
            <select id="brokerSelect"><option value="" disabled selected>–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É</option></select>

            <label class="form-label">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
            <input type="text" id="clientName" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">

            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞</label>
            <input type="tel" id="clientPhone" placeholder="+7 999 000-00-00">

            <label class="form-label">–ë—é–¥–∂–µ—Ç ($)</label>
            <input type="text" id="clientBudget" inputmode="decimal" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 250 000">

            <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
            <textarea id="comment" placeholder="–°—Ä–æ–∫–∏, –ø–æ–∂–µ–ª–∞–Ω–∏—è, –Ω—é–∞–Ω—Å—ã..."></textarea>
        </div>
    </div>

    <div id="hrRequestScreen" class="app-screen hidden">
        <div class="my-form-container">
            <h3 class="form-title">–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–¥–±–æ—Ä</h3>
            
            <label class="form-label">–ö–æ–≥–æ –∏—â–µ–º? (–î–æ–ª–∂–Ω–æ—Å—Ç—å)</label>
            <input type="text" id="hrPosition" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë—Ä–æ–∫–µ—Ä –û–ê–≠">

            <label class="form-label">–¢—Ä–µ–±—É–µ–º—ã–π –æ–ø—ã—Ç</label>
            <select id="hrExperience">
                <option value="–ë–µ–∑ –æ–ø—ã—Ç–∞">–ë–µ–∑ –æ–ø—ã—Ç–∞</option>
                <option value="–û—Ç 1 –¥–æ 3 –ª–µ—Ç" selected>–û—Ç 1 –¥–æ 3 –ª–µ—Ç</option>
                <option value="–û—Ç 3 –¥–æ 6 –ª–µ—Ç">–û—Ç 3 –¥–æ 6 –ª–µ—Ç</option>
                <option value="–ë–æ–ª–µ–µ 6 –ª–µ—Ç">–ë–æ–ª–µ–µ 6 –ª–µ—Ç</option>
            </select>

            <label class="form-label">–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–∞—è –ó–ü / –§–∏–∫—Å ($)</label>
            <input type="text" id="hrSalary" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1000$ + %">

            <label class="form-label">–û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –∑–∞–¥–∞—á–∏</label>
            <textarea id="hrRequirements" placeholder="–û–ø–∏—à–∏—Ç–µ, —á–µ–º –±—É–¥–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å—Å—è —á–µ–ª–æ–≤–µ–∫ –∏ –∫–∞–∫–∏–µ –Ω–∞–≤—ã–∫–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã..."></textarea>
        </div>
    </div>

    <div id="hrCabinetScreen" class="app-screen hidden">
        <div class="my-form-container" style="text-align: center;">
            <h3 class="form-title">–ö–∞–±–∏–Ω–µ—Ç HR</h3>
            <p style="color: #666; font-size: 15px; margin-top: 50px;">
                –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∫–ª–∏–∫–∞–º–∏ –∏ –≤–∞–∫–∞–Ω—Å–∏—è–º–∏. 
                <br><br>–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ üõ†Ô∏è
            </p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#ffffff'); tg.setBackgroundColor('#ffffff');

        // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
        // –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û–¢ ID –ù–ê TELEGRAM ID –í–ê–®–ï–ì–û HR (–¶–ò–§–†–´)!
        const ALLOWED_HR_IDS = [123456789, 987654321]; 
        
        const GET_URL = 'https://n8n.nevn8n8amocrm.online/webhook/72ab1905-055c-4452-ae15-16245b46693e';
        const POST_REFERRAL_URL = 'https://n8n.nevn8n8amocrm.online/webhook/f2cd4077-afb6-428e-adc0-4357783010a7';
        // –í–ê–ú –ù–£–ñ–ï–ù –ù–û–í–´–ô –í–ï–ë–•–£–ö –í N8N –î–õ–Ø –ü–†–ò–ï–ú–ê HR –ó–ê–Ø–í–û–ö:
        const POST_HR_URL = 'https://n8n.nevn8n8amocrm.online/webhook/NEW-HR-WEBHOOK-ID'; 

        let allBrokers = []; let allCountries = [];
        let currentScreenId = 'loaderScreen';

        // 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        async function init() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–ª—è –∫–Ω–æ–ø–∫–∏ HR
            const currentUserId = tg.initDataUnsafe.user?.id;
            // –ï—Å–ª–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ HR, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            if (ALLOWED_HR_IDS.includes(currentUserId)) {
                document.getElementById('hrCabinetBtn').classList.remove('hidden');
            }

            try {
                const res = await fetch(GET_URL, { method: 'GET', headers: { 'Content-Type': 'application/json' }});
                if (!res.ok) throw new Error("Network error");
                const data = await res.json();
                allBrokers = data.brokers; allCountries = data.countries;
                
                renderSelects();
                openScreen('mainMenuScreen'); // –ò–¥–µ–º –≤ –º–µ–Ω—é
            } catch (error) {
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
            }
        }

        // 2. –û–¢–†–ò–°–û–í–ö–ê –°–ï–õ–ï–ö–¢–û–í
        function renderSelects() {
            const cSelect = document.getElementById('countrySelect');
            cSelect.innerHTML = '<option value="" selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É</option>';
            allCountries.forEach(c => cSelect.innerHTML += `<option value="${c}">${c}</option>`);
        }

        function filterBrokers() {
            const selectedCountry = document.getElementById('countrySelect').value;
            const bSelect = document.getElementById('brokerSelect');
            bSelect.innerHTML = '<option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–æ–∫–µ—Ä–∞</option>';
            const filtered = selectedCountry ? allBrokers.filter(b => b.countries.includes(selectedCountry)) : allBrokers;
            filtered.forEach(b => bSelect.innerHTML += `<option value="${b.id}">${b.name}</option>`);
        }

        // 3. –£–ú–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø
        function openScreen(screenId) {
            // –ü—Ä—è—á–µ–º —Ç–µ–∫—É—â–∏–π
            document.getElementById(currentScreenId).classList.add('hidden');
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π
            document.getElementById(screenId).classList.remove('hidden');
            currentScreenId = screenId;

            // –û—á–∏—â–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∫–Ω–æ–ø–æ–∫, —á—Ç–æ–±—ã –Ω–µ –¥–≤–æ–∏–ª–∏—Å—å
            tg.MainButton.offClick(submitReferral);
            tg.MainButton.offClick(submitHrRequest);
            tg.BackButton.offClick(goBack);

            if (screenId === 'mainMenuScreen') {
                tg.BackButton.hide();
                tg.MainButton.hide();
            } else {
                // –ï—Å–ª–∏ –º—ã –≤–Ω—É—Ç—Ä–∏ –∫–∞–∫–æ–π-—Ç–æ —Ñ–æ—Ä–º—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ù–∞–∑–∞–¥"
                tg.BackButton.show();
                tg.BackButton.onClick(goBack);

                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ì–ª–∞–≤–Ω—É—é –ö–Ω–æ–ø–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
                if (screenId === 'referralFormScreen') {
                    tg.MainButton.setText("–û–¢–ü–†–ê–í–ò–¢–¨ –õ–ò–î");
                    tg.MainButton.setParams({ color: '#bba589', text_color: '#ffffff' });
                    tg.MainButton.onClick(submitReferral);
                    tg.MainButton.show();
                } else if (screenId === 'hrRequestScreen') {
                    tg.MainButton.setText("–û–¢–ü–†–ê–í–ò–¢–¨ –ó–ê–Ø–í–ö–£");
                    tg.MainButton.setParams({ color: '#333333', text_color: '#ffffff' }); // –ß–µ—Ä–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è HR
                    tg.MainButton.onClick(submitHrRequest);
                    tg.MainButton.show();
                } else if (screenId === 'hrCabinetScreen') {
                    tg.MainButton.hide(); // –í –∫–∞–±–∏–Ω–µ—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
                }
            }
        }

        function goBack() { openScreen('mainMenuScreen'); }

        // 4. –§–£–ù–ö–¶–ò–ò –û–¢–ü–†–ê–í–ö–ò
        async function submitReferral() {
            const brokerId = document.getElementById('brokerSelect').value;
            const clientName = document.getElementById('clientName').value;
            const clientPhone = document.getElementById('clientPhone').value;
            
            if (!brokerId || !clientName || !clientPhone) { tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ë—Ä–æ–∫–µ—Ä–∞, –ò–º—è –∏ –¢–µ–ª–µ—Ñ–æ–Ω!"); return; }
            tg.MainButton.showProgress();

            const payload = {
                type: 'lead_referral',
                sender_name: tg.initDataUnsafe.user?.first_name,
                sender_tg_id: tg.initDataUnsafe.user?.id,
                target_broker_id: brokerId,
                country: document.getElementById('countrySelect').value,
                client_name: clientName,
                client_phone: clientPhone,
                budget: document.getElementById('clientBudget').value,
                comment: document.getElementById('comment').value
            };

            await sendData(POST_REFERRAL_URL, payload, "‚úÖ –õ–∏–¥ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω!");
        }

        async function submitHrRequest() {
            const position = document.getElementById('hrPosition').value;
            if (!position) { tg.showAlert("–£–∫–∞–∂–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å!"); return; }
            tg.MainButton.showProgress();

            const payload = {
                type: 'hr_request',
                sender_name: tg.initDataUnsafe.user?.first_name,
                sender_tg_id: tg.initDataUnsafe.user?.id,
                position: position,
                experience: document.getElementById('hrExperience').value,
                salary: document.getElementById('hrSalary').value,
                requirements: document.getElementById('hrRequirements').value
            };

            await sendData(POST_HR_URL, payload, "‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ HR!");
        }

        async function sendData(url, payload, successMsg) {
            try {
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                tg.MainButton.hideProgress();
                if (res.ok) { tg.showAlert(successMsg); openScreen('mainMenuScreen'); } 
                else { tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."); }
            } catch (error) {
                tg.MainButton.hideProgress();
                tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.");
            }
        }

        init();
    </script>
</body>
</html>
