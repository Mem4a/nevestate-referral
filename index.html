// Новый URL для авторизации (создай его в n8n)
const AUTH_URL = 'https://n8n.nevn8n8amocrm.online/webhook/b0607fcb-775f-466e-8f2d-cc3b81fb632e'; 
let currentUser = null; // Здесь будем хранить данные юзера после входа

async function init() {
    const tgId = tg.initDataUnsafe.user?.id;
    
    // Если мы тестируем в браузере (без ТГ), можно заглушить:
    // const tgId = 1211686949; 

    if (!tgId) {
        showScreen('accessDeniedScreen');
        return;
    }

    try {
        // 1. Стучимся в n8n для проверки прав
        const authRes = await fetch(AUTH_URL, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tg_id: tgId })
        });
        
        if (!authRes.ok) throw new Error("Server error");
        
        const data = await authRes.json();
        
        // 2. Проверяем доступ
        if (data.status === 'error' || !data.is_active) {
            showScreen('accessDeniedScreen');
            return;
        }

        // 3. Сохраняем профиль
        currentUser = data; // { name: "Егор", roles: "Admin", ... }
        const roles = currentUser.roles.split(',').map(r => r.trim()); // Превращаем строку "Broker, HR" в массив ["Broker", "HR"]

        // 4. Распределяем кнопки на Главном Экране
        
        // Админ видит ВСЁ.
        const isAdmin = roles.includes('Admin');

        if (isAdmin || roles.includes('Broker')) {
            document.getElementById('brokerCabinetBtn').classList.remove('hidden'); // Создай эту кнопку в HTML
        }
        
        if (isAdmin || roles.includes('HR')) {
            document.getElementById('hrCabinetBtn').classList.remove('hidden');
        }
        
        if (isAdmin || roles.includes('Head')) {
            document.getElementById('headCabinetBtn').classList.remove('hidden'); // Создай эту кнопку в HTML
        }

        // 5. Загружаем справочники (страны/брокеры для формы рефералов)
        await loadDictionaries();

        // 6. Открываем меню
        openScreen('mainMenuScreen');

    } catch (error) {
        alert("Ошибка авторизации. Проверьте интернет.");
    }
}
